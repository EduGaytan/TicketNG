<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket</title>

    <style>
        /* --- AJUSTES DE IMPRESIÓN --- */
        @page {
            margin: 0;
            size: 58mm auto;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #fff;
            /* Usamos Flexbox para centrar el contenido en la tira de papel */
            display: flex;
            justify-content: center; 
        }

        /* --- CONTENEDOR PRINCIPAL (EL TRUCO) --- */
        /* Reducimos a 45mm para asegurar que entre en el área imprimible real */
        .ticket-container {
            width: 45mm; 
            padding-top: 1mm;
        }

        /* Tipografía */
        * {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            font-size: 11px; /* Reduje 1px para ganar espacio horizontal */
            color: #000;
            box-sizing: border-box;
            font-weight: 600;
        }

        /* --- LOGO --- */
        .svg-container {
            width: 100%;
            text-align: center;
            margin-bottom: 2mm;
        }
        #logo {
            max-width: 90%;
            height: auto;
        }

        /* --- TÍTULO PRINCIPAL (Petición Específica) --- */
        .business-name {
            font-size: 18px !important; /* Mucho más grande */
            font-weight: 900 !important; /* Extra negrita */
            text-transform: uppercase;
            display: block;
            margin-bottom: 1mm;
        }

        /* --- ENCABEZADOS Y PIE --- */
        .ticket-header, .ticket-footer {
            text-align: center;
            margin-bottom: 2mm;
        }
        .ticket-header p, .ticket-footer p {
            margin: 0.5mm 0;
            line-height: 1.2;
        }

        /* --- LÍNEAS DE INFORMACIÓN --- */
        .info-line {
            display: flex;
            justify-content: space-between;
            margin: 0.5mm 0;
        }

        /* --- TABLA DE ARTÍCULOS --- */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2mm;
            margin-bottom: 2mm;
        }
        .items-table th {
            border-bottom: 1px dashed #000;
            text-align: right; /* Alineamos a derecha para evitar cortes */
            padding-bottom: 1mm;
            font-size: 10px; /* Encabezados un poco más chicos */
        }
        .items-table td {
            padding: 1mm 0;
            vertical-align: top;
            font-size: 11px;
        }
        
        /* Ajuste de columnas crítico para evitar cortes */
        .col-desc { text-align: left; width: 42%; }
        .col-qty  { text-align: center; width: 10%; }
        .col-price { text-align: right; width: 22%; }
        .col-subtotal { text-align: right; width: 26%; }

        /* --- SEPARADOR --- */
        .separator {
            border-top: 1px dashed #000;
            margin: 2mm 0;
        }

        /* --- TABLA DE TOTALES --- */
        .totals-table {
            width: 100%;
            border-collapse: collapse;
        }
        .totals-table td {
            padding: 0.5mm 0;
            border: none;
        }
        .totals-table td.label {
            text-align: right;
            padding-right: 2mm;
            width: 55%;
        }
        .totals-table td.value {
            text-align: right;
            width: 45%;
        }
        .text-lg { font-size: 15px; } 

        /* --- CÓDIGO DE BARRAS --- */
        .barcode-container {
            text-align: center;
            margin-top: 3mm;
            margin-bottom: 5mm;
            overflow: hidden; /* Evita desborde */
        }
        .barcode-container img {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>

<body>

    <!-- Contenedor ajustado a 45mm -->
    <div class="ticket-container">

        <!-- LOGO (SVG PLACEHOLDER) -->
        <div class="svg-container">
           <img src="https://via.placeholder.com/150x50?text=LOGO" alt="Logo" id="logo_img" style="display:none;"> 
           <svg id="logo" version="1.0" xmlns="http://www.w3.org/2000/svg" width="100%" height="auto" viewBox="0 0 1280 180" preserveAspectRatio="xMidYMid meet">
                <!-- Pega aquí el contenido de tu SVG -->
           </svg>
        </div>

        <!-- DATOS FIJOS DEL NEGOCIO -->
        <div class="ticket-header">
            <!-- Clase business-name aplicada aquí -->
            <span class="business-name">NOVEDADES GAYTAN</span>
            <p>RFC: GAOE6603281X3</p>
            <p>Av. Hidalgo #8 Moroleón, Gto.</p>
            <p>Tel: 445 458 2720</p>
            <p>WhatsApp: 445 100 9780</p>
            <p>www.novedadesgaytan.com.mx</p>
        </div>

        <!-- DATOS VARIABLES -->
        <div class="info-line">
            <span># Ticket:</span>
            <span id="Ticket_id"></span>
        </div>
        <div class="info-line">
            <span>Fecha:</span>
            <span id="FechaHora_id"></span>
        </div>
        <div class="info-line">
            <span>Tipo:</span>
            <span id="Tipo_id"></span>
        </div>

        <!-- TABLA DE PRODUCTOS -->
        <table class="items-table">
            <thead>
                <tr>
                    <th class="col-desc">Desc</th>
                    <th class="col-qty">Cant</th>
                    <th class="col-price">P.U.</th>
                    <th class="col-subtotal">Importe</th>
                </tr>
            </thead>
            <tbody id="tablaBody">
                <!-- JS Generará esto -->
            </tbody>
        </table>

        <div class="separator"></div>

        <!-- SECCIÓN DE TOTALES DINÁMICA -->
        <div class="totals-section">
            <table class="totals-table" id="totalsTable">
                <!-- JS Generará esto -->
            </table>
        </div>

        <div class="separator"></div>

        <!-- PIE DE TICKET -->
        <div class="ticket-footer">
            <p>*** Gracias por su compra ***</p>
            <p>Necesario ticket para cambio.</p>
            <p>Límite 30 días.</p>
        </div>

        <!-- CÓDIGO DE BARRAS -->
        <div class="barcode-container">
            <img id="barcodeImg" src="" alt="Barcode">
        </div>
    </div> <!-- Fin ticket-container -->

    <script>
        // --- 1. OBTENCIÓN DE PARÁMETROS ---
        const params = new URLSearchParams(window.location.search);
        const getP = (name, def = "") => params.has(name) ? params.get(name) : def;
        const getNum = (name) => parseFloat(getP(name, "0")) || 0;

        const ticketData = {
            id: getP('Ticket'),
            fecha: getP('FechaHora'),
            tipo: getP('TipoTicket', 'Venta'),
            formaPago: getP('FormaPago'),
            barcodeUrl: getP('BarCode')
        };

        let descripcion = getP('Descripción', 'Varios').split(" , ");
        let qty = getP('Qty', '1').split(" , ");
        let precio = getP('PrecioDescuento', '0').split(" , ");
        let subtotal = getP('SubtotalDescuento', '0').split(" , ");

        const money = (num) => "$" + num.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        // --- 2. POBLAR ENCABEZADOS ---
        document.getElementById("Ticket_id").textContent = ticketData.id;
        document.getElementById("FechaHora_id").textContent = ticketData.fecha;
        document.getElementById("Tipo_id").textContent = ticketData.tipo.toUpperCase();

        // --- 3. GENERAR TABLA DE PRODUCTOS ---
        const tablaBody = document.getElementById("tablaBody");
        
        descripcion.forEach((desc, index) => {
            if(desc) {
                let p = parseFloat(precio[index]) || 0;
                let s = parseFloat(subtotal[index]) || 0;
                let q = qty[index] || 1;

                let row = document.createElement("tr");
                row.innerHTML = `
                    <td class="col-desc">${desc}</td>
                    <td class="col-qty">${q}</td>
                    <td class="col-price">${money(p)}</td>
                    <td class="col-subtotal">${money(s)}</td>
                `;
                tablaBody.appendChild(row);
            }
        });

        // --- 4. LÓGICA DE TOTALES ---
        const totalsTable = document.getElementById("totalsTable");
        let htmlTotales = "";

        let recibido = getNum('Recibido');
        let cambio = getNum('Cambio');
        let totalGeneral = getNum('Total'); 

        switch (ticketData.tipo) {
            case "Venta":
                let ahorro = getNum('Ahorro');
                htmlTotales += `
                    <tr class="text-lg"><td class="label">TOTAL:</td><td class="value">${money(totalGeneral)}</td></tr>
                    <tr><td class="label">Forma Pago:</td><td class="value">${ticketData.formaPago}</td></tr>
                    <tr><td class="label">Recibido:</td><td class="value">${money(recibido)}</td></tr>
                    <tr><td class="label">Cambio:</td><td class="value">${money(cambio)}</td></tr>
                `;
                if(ahorro > 0) {
                    htmlTotales += `<tr><td class="label">Usted Ahorró:</td><td class="value">${money(ahorro)}</td></tr>`;
                }
                break;

            case "Cambio":
                let saldoCliente = getNum('SaldoAFavorCliente');
                let saldoEmpresa = getNum('SaldoAFavorEmpresa');
                let diferencia = getNum('DiferenciaTotal');
                
                htmlTotales += `
                    <tr><td class="label">Saldo Favor Cte:</td><td class="value">${money(saldoCliente)}</td></tr>
                    <tr><td class="label">Nuevo Consumo:</td><td class="value">${money(saldoEmpresa)}</td></tr>
                    <tr class="text-lg"><td class="label">DIFERENCIA:</td><td class="value">${money(diferencia)}</td></tr>
                    <tr><td class="label">Forma Pago:</td><td class="value">${ticketData.formaPago}</td></tr>
                    <tr><td class="label">Recibido:</td><td class="value">${money(recibido)}</td></tr>
                    <tr><td class="label">Cambio:</td><td class="value">${money(cambio)}</td></tr>
                `;
                break;

            case "Diferido":
                let abono = getNum('Abono');
                let restante = getNum('Restante');
                
                htmlTotales += `
                    <tr class="text-lg"><td class="label">TOTAL:</td><td class="value">${money(totalGeneral)}</td></tr>
                    <tr><td class="label">Abono Realizado:</td><td class="value">${money(abono)}</td></tr>
                    <tr><td class="label">Saldo Restante:</td><td class="value">${money(restante)}</td></tr>
                    <tr><td class="label">Forma Pago:</td><td class="value">${ticketData.formaPago}</td></tr>
                    <tr><td class="label">Recibido:</td><td class="value">${money(recibido)}</td></tr>
                    <tr><td class="label">Cambio:</td><td class="value">${money(cambio)}</td></tr>
                `;
                break;
                
            default:
                htmlTotales += `
                    <tr class="text-lg"><td class="label">TOTAL:</td><td class="value">${money(totalGeneral)}</td></tr>
                    <tr><td class="label">Recibido:</td><td class="value">${money(recibido)}</td></tr>
                    <tr><td class="label">Cambio:</td><td class="value">${money(cambio)}</td></tr>
                `;
        }

        totalsTable.innerHTML = htmlTotales;

        // --- 5. CÓDIGO DE BARRAS ---
        const barcodeImg = document.getElementById("barcodeImg");
        if (ticketData.barcodeUrl && ticketData.barcodeUrl.trim() !== "") {
            barcodeImg.src = ticketData.barcodeUrl;
        } else {
            document.querySelector('.barcode-container').style.display = 'none';
        }

        // --- IMPRESIÓN ---
        window.onload = function() {
            setTimeout(function() {
                window.print();
            }, 800);
        }
    </script>
</body>
</html>
